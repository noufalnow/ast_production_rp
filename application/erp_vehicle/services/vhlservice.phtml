<div class="dynamic-popup" id="dynamic-popup"><!--  -->
	<form name="form" method="post" id="edit" action='erp_vehicle/services/vhlservice/ref/<?=$this->param['ref']?>' style="margin-bottom: 0px;">
	<div class="modal-header">
				<h4 class="card-title">Service details</h4>
				<button type="button" aria-label="Close" class="btn-close" data-bs-dismiss="modal">
					<span aria-hidden="true">Ã—</span>
				</button>
	</div>
	<div class="modal-body">
				<div class="row mb-4" style="margin-top: 15px;">
					<label class="col-sm-3 form-label" >Status</label>
					<div class="col-sm-3">
                    <?=$this->form->status->show()?>
                  </div>    
				</div>
				<div class="row mb-4">
					<label class="col-sm-3 form-label" >Date of Service</label>
					<div class="col-sm-3">
                    <?=$this->form->servicedt->show()?>
                  </div>
                  <label class="col-sm-2 form-label" >Reading (KM)</label>
					<div class="col-sm-4">
                    <?=$this->form->reading->show()?>
                  </div>
				</div>
				<div class="row mb-4">
					<label class="col-sm-3 form-label" >Service Done By</label>
					<div class="col-sm-3">
                    <?=$this->form->employee->show()?>
                  </div>
					<label class="col-sm-2 form-label" >Location</label>
					<div class="col-sm-4">
                    <?=$this->form->location->show()?>
                  </div>
				</div>
				<div class="row mb-4">
					<label class="col-sm-3 form-label" >Wash</label>
					<div class="col-sm-3">
                    <?=$this->form->wash->show()?>
                  </div>
                  <label class="col-sm-2 form-label" >Greese</label>
					<div class="col-sm-3">
                    <?=$this->form->greese->show()?>
                  </div>
				</div>

				<div class="row mb-4">
					<label class="col-sm-3 form-label" >Note</label>
					<div class="col-sm-9">
                    <?=$this->form->note->show()?>
                  </div>
				</div>	


                <div class="row mb-4 align-items-center">
                    <!-- Label and Input for "Next" -->
                    <label class="form-label" style="width: 10%;">Next</label>
                    <div style="width: 15%;">
                        <?=$this->form->nxtstatus->show()?>
                    </div>
                
                    <!-- Label and Input for "Reading (KM)" -->
                    <label class="form-label" style="width: 10%;">Reading (KM)</label>
                    <div style="width: 15%;">
                        <?=$this->form->readingnxt->show()?>
                    </div>
                
                    <!-- Label and Input for "Date" -->
                    <label class="form-label" style="width: 10%;">Date</label>
                    <div style="width: 15%;">
                        <?=$this->form->nextDt->show()?>
                    </div>
                
                    <!-- Label and Input for "Labour" -->
                    <label class="form-label" style="width: 10%;">Labour</label>
                    <div style="width: 15%;">
                        <?=$this->form->labour->show()?>
                    </div>
                </div>



	
				<div class="row mb-4">
				<div id="mh_varis" class="col-sm-12">
                    <table width="100%" id="multi_table">
					<tr style="font-size: 0.8em;">
                        <th width="20%" style="padding-bottom: 5px;">Item</th>
                        <th width="10%" style="padding-bottom: 5px;">Quantity</th>
                        <th width="10%" style="padding-bottom: 5px;">Unit</th>
                        <th width="20%" style="padding-bottom: 5px;">Done By</th>
                        <th width="20%" style="padding-bottom: 5px;">Note</th>
                        <th width="10%" style="padding-bottom: 5px;">Price</th>
                        <th width="10%" style="padding-bottom: 5px;">Expense</th>
                        <th width="0%" style="padding-bottom: 5px;"></th> <!-- Optional column for spacing -->

					</tr>
					<tbody id="dup_body">
					<?php foreach($this->mfields as $i):?>
					<tr class="dup_row" index="<?=$i?>">
						<td valign="top">
		                	<?=$this->form->item[$i]->show()?>
						</td>
						<td valign="top">
		                	<?=$this->form->quantity[$i]->show()?>
						</td>
						<td valign="top">
		                	<?=$this->form->munit[$i]->show()?>
						</td>

						<td valign="top">
		                		<?=$this->form->doneby[$i]->show()?>
						</td>
						<td valign="top">
		                		<?=$this->form->mnote[$i]->show()?>
						</td>
						<td valign="top">
		                		<?=$this->form->mprice[$i]->show()?>
						</td>
						<td valign="top">
		                		<?=$this->form->mbillid[$i]->show()?>
						</td>
						<td valign="middle">
			              <div>
							<a style="color: blue; margin: 1px;" title="Remove" href="#" onclick="delRow(this);return false;" class="glyphicon glyphicon-remove"></a>
			              </div>
						</td>
					</tr>
					<?php endforeach;?>
					</tbody>
					</table>
					<div><a  style="background-color: yellowgreen;margin: 1px;" id="myLink" title="Add more" href="#" onclick="addRow('multi_table');return false;" class="btn">More</a>
					</div>
                 </div>			
                  	</div>
    </div>
	<div class="modal-footer">
		<button type="button" class="btn btn-primary submit-alias livepost">Save
			changes</button>
		<button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
	</div>
</form>	
</div>
<script type="text/javascript">
var rowTemplates = {
    multi_table: '',
    multi_table_item: ''
};

// Initialize row templates for different tables
$(document).ready(function () {
    rowTemplates.multi_table = '<tr class="dup_row">' + $('#dup_body > tr:first').html() + '</tr>';
    rowTemplates.multi_table_item = '<tr class="dup_row_item">' + $('#dup_body_item > tr:first').html() + '</tr>';
});

// Generic function to add a row
function addRow(tableId) {
    var tableBodyId = getTableBodyId(tableId); // Get the corresponding tbody ID
    var lastRow = $('#' + tableBodyId + ' > tr:last'); // Find the last row in the tbody
    var index = parseInt(lastRow.attr('index')) || 1; // Get the index of the last row
    index++;

    console.log(index);

    // Clone the row template but exclude Chosen-rendered containers
    var newRow = $(rowTemplates[tableId]).clone();
    newRow.attr('index', index);

    // Remove existing Chosen containers from the cloned row
    newRow.find('.chosen-container').remove();

    // Reset the new row's input values, remove errors, and update names/IDs
    newRow.find(':input').each(function () {
        var name = $(this).attr('name');
        if (name) {
            var newName = name.replace(/\[\d+\]/, '[' + index + ']');
            $(this).attr('name', newName).attr('id', newName).val(''); // Update name and id, clear value
        }
    });

    newRow.find('.input_error').removeClass('input_error');
    newRow.find('.select_error').removeClass('select_error');
    newRow.find('.error_text').remove();

    // Insert the new row after the last one
    lastRow.length ? lastRow.after(newRow) : $('#' + tableBodyId).append(newRow);
    reindexRows(tableBodyId);
    

    // Reinitialize Chosen only for the new row
    newRow.find('.chosen-select').chosen({
        no_results_text: "Oops, nothing found!",
        search_contains: true,
        enable_split_word_search: true
    });
}


// Generic function to delete a row
function delRow(row) {
    var tableBody = $(row).closest('tbody'); // Find the parent tbody
    var rowCount = tableBody.find('tr').length; // Count rows

    console.log("Row Count Before Deletion:", rowCount);

    // Ensure at least one row remains
    if (rowCount > 1) {
        $(row).closest('tr').remove(); // Remove the row
        console.log("Row deleted. Reindexing rows...");
        reindexRows(tableBody.attr('id')); // Reindex remaining rows
    } else {
        console.log("Cannot delete the last row.");
    }
}

// Utility function to get the corresponding tbody ID
function getTableBodyId(tableId) {
    return tableId === 'multi_table' ? 'dup_body' : 'dup_body_item';
}

// Utility function to get the corresponding row class
function getRowClass(tableId) {
    return tableId === 'multi_table' ? 'dup_row' : 'dup_row_item';
}

function reindexRows(tableBodyId) {
    $('#' + tableBodyId + ' > tr').each(function (i) {
        $(this).attr('index', i + 1); // Update the index attribute
        $(this).find(':input').each(function () {
            var name = $(this).attr('name');
            if (name) {
                var newName = name.replace(/\[\d+\]/, '[' + (i + 1) + ']');
                $(this).attr('name', newName).attr('id', newName);
            }
        });
    });
}

</script>

<style>
.modal-dialog{
	width: 90%;
}
</style>