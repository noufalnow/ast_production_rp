


<!-- APP-CONTENT OPEN -->
<div class="main-content app-content mt-0">
	<div class="side-app">
		<!-- CONTAINER -->
		<div class="main-container container-fluid">
			<!-- PAGE-HEADER -->
			<div class="page-header">
				<div>
					<h1 class="page-title">Dashboard</h1>
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a href="javascript:void(0);">Home</a>
						</li>
						<li class="breadcrumb-item active" aria-current="page">Dashboard</li>
					</ol>
				</div>
				<div class="ms-auto pageheader-btn">

					<button type="button"
						class="btn btn-primary btn-icon text-white me-2">             
               <?=x(array('link' => 'erp_expense/expense/add','label' => '<span class="text-white">
                    <i class="fe fe-plus"> Add Expense</i>
                  </span>',array("param" => 'class="facebox"')), '<br><br>')?></button>
					<button class="btn btn-secondary-gradient" type="button"
						onClick="tableToExcelX();">Excel</button>

				</div>
			</div>
			<!-- PAGE-HEADER END -->
            
            
            <?php
            $orderedColumns = $this->columns;
            $pivot = $this->pivot;
            $rowTotals = $this->rowTotals;
            $columnTotals = $this->columnTotals;
            $columnMeta = $this->columnMeta;
            $grandTotal = $this->grandTotal;
            $rawColumnTotals = $this->rawColumnTotals;
            $columnLabel = $this->columnLabel;

            ?>

            <div class="pivot-scroll">
                <table class="pivot-table" id="report_table">
                    <thead>
                        <tr>
                            <th style="text-align: center; vertical-align: bottom; width: 40px !important;">
                                DATE
                            </th>
            
                            <?php foreach ($orderedColumns as $col): ?>
                                <th class="rotate"
                                    data-col="<?= htmlspecialchars($col) ?>"
                                    data-meta="<?= $columnMeta[$col] ?>"
                                    data-head="<?= $columnHead[$col] ?>">
                                    <div><?= htmlspecialchars($columnLabel[$col]) ?></div>
                                </th>
                            <?php endforeach; ?>
            
                            <th style="text-align: center; vertical-align: bottom;">
                                ROW&nbsp;TOTAL
                            </th>
                        </tr>
                    </thead>
            
                    <tbody>
                        <?php foreach ($pivot as $date => $cols): ?>
                            <tr>
                                <td><?= $date ?></td>
            
                                <?php foreach ($orderedColumns as $col): ?>
                                    <td><?= number_format($cols[$col], 3) ?></td>
                                <?php endforeach; ?>
            
                                <td class="row-total">
                                    <?= number_format($rowTotals[$date], 3) ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
            
                        <!-- RAW COLUMN TOTAL -->
                        <tr class="raw-total">
                            <td>RAW&nbsp;TOTAL</td>
            
                            <?php foreach ($orderedColumns as $col): ?>
                                <td><?= number_format($rawColumnTotals[$col], 3) ?></td>
                            <?php endforeach; ?>
            
                            <td class="dash">-</td>
                        </tr>
            
                        <!-- FINAL TOTAL -->
                        <tr class="final-total">
                            <td>TOTAL</td>
            
                            <?php foreach ($orderedColumns as $col): ?>
                                <td>
                                    <?php
                                    if ($columnMeta[$col] === 'HEAD') {
                                        echo number_format($columnTotals[$col], 3);
                                    } else {
                                        echo '<span class="dash">-</span>';
                                    }
                                    
                                    ?>
                                </td>
                            <?php endforeach; ?>
            
                            <td class="grand-total">
                                <?= number_format($grandTotal, 3) ?>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>


<canvas id="expenseStackedChart" height="50"></canvas>



		</div>
		<!-- CONTAINER END -->
	</div>
</div>
<!-- APP-CONTENT END -->



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>





<script>

baseurl = '<?=APPURL;?>';


<?php  if(USER_GROUP<>99):?>
$(document).ready(function($) {
	getContent(baseurl+'default/default/notify');
});	
<?php endif; ?>


function tableToExcelX() {
	let table = document.getElementById("report_table");
	var dt = new Date();
	var time = (dt.getMonth() + 1) + '' + dt.getDate() + '' + dt.getFullYear() + '' + dt.getHours() + '' + dt.getMinutes() + dt.getSeconds();
	TableToExcel.convert(table, { // html code may contain multiple tables so here we are refering to 1st table tag
		name: `Export_Report_` + time + `.xlsx`, // fileName you could use any name
		sheet: {
			name: 'Sheet 1' // sheetName
		}
	});
}


const chartDates = <?= json_encode($this->dates) ?>;
const chartHeads = <?= json_encode($this->heads) ?>;
const chartData  = <?= json_encode($this->chartData) ?>;
</script>


<script>
const colors = {
    '[EMPLOYEE]': '#4e79a7',
    '[VEHICLES]': '#59a14f',
    '[OTHERS]'  : '#e15759'
};

const datasets = chartHeads.map(head => ({
    label: head,
    data: chartDates.map(d => chartData[d][head]),
    backgroundColor: colors[head] || '#999',
    stack: 'expense'
}));

const ctx = document.getElementById('expenseStackedChart').getContext('2d');

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: chartDates,
        datasets: datasets
    },
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                mode: 'index',
                intersect: false
            },
            legend: {
                position: 'top'
            }
        },
        scales: {
            x: {
                stacked: true,
                title: { display: true, text: 'Date' }
            },
            y: {
                stacked: true,
                title: { display: true, text: 'Amount' }
            }
        }
    }
});
</script>





<style>
.pivot-table {
	width: 100%;
	border-collapse: collapse;
	font-family: "Segoe UI", Arial, sans-serif;
	font-size: 13px;
	color: #333;
}

/* Header */
.pivot-table thead th {
	/*background: #2f4050;*/
	color: #370d0d;
	/*text-align: center;*/
	padding: 8px 6px;
	border: 1px solid #d1d1d1;
	white-space: nowrap;
	font-weight: lighter;
}

/* Body cells */
.pivot-table td {
	border: 1px solid #dcdcdc;
	padding: 6px 8px;
	text-align: right;
}

/* Date column */
.pivot-table td:first-child {
	text-align: left;
	font-weight: 600;
	background: #fafafa;
}

/* Zebra rows */
.pivot-table tbody tr:nth-child(even) {
	background: #f9f9f9;
}

/* Row total */
.pivot-table .row-total {
	font-weight: 700;
	background: #eef4ff;
}

/* RAW TOTAL row */
.pivot-table .raw-total {
	background: #fff3cd;
	font-weight: 700;
	border-top: 2px solid #e0b400;
}

/* FINAL TOTAL row */
.pivot-table .final-total {
	background: #f3f3f3;
	font-weight: 800;
	border-top: 2px solid #999;
}

/* Grand total cell */
.pivot-table .grand-total {
	background: #dff0d8;
	font-weight: 800;
}

/* Dash cell */
.pivot-table .dash {
	color: #999;
	/*text-align: center;*/
}

/* Hover effect */
.pivot-table tbody tr:hover {
	background: #eef6ff;
}

/* Horizontal scroll container */
.pivot-scroll {
	width: 100%;
	overflow-x: auto;
	overflow-y: visible;
	border: 1px solid #ddd;
	background: #fff;
}

/* Keep table wider than viewport */
.pivot-table {
	min-width: 1200px; /* adjust based on column count */
}

/* Smooth scrolling */
.pivot-scroll::-webkit-scrollbar {
	height: 8px;
}

.pivot-scroll::-webkit-scrollbar-thumb {
	background: #bbb;
	border-radius: 4px;
}

.pivot-scroll::-webkit-scrollbar-track {
	background: #f1f1f1;
}

/* Rotated column */
.pivot-table th.rotate {
	width: 40px;
	min-width: 40px;
	max-width: 40px;
	height: 260px;
	padding: 0;
	position: relative;
	vertical-align: bottom;
}

/* Rotated text â€” TOP aligned */
.pivot-table th.rotate>div {
	position: absolute;
	top: 257px; /* ðŸ‘ˆ start from top */
	left: 16px;
	transform: rotate(-90deg);
	transform-origin: top left;
	white-space: nowrap;
}

/* Enable wrapping ONLY when long */
.pivot-table th.rotate.wrap>div {
	white-space: normal;
	max-height: 260px;
	overflow: hidden;
	display: -webkit-box;
	-webkit-box-orient: vertical;
	-webkit-line-clamp: 3;
}

/* HEAD */
.pivot-table th[data-meta="HEAD"],
.pivot-table td[data-meta="HEAD"] {
    background-color: #e8f0ff;
    font-weight: 700;
}

/* CATEGORY */
.pivot-table th[data-meta="CATEGORY"],
.pivot-table td[data-meta="CATEGORY"] {
    background-color: #f3f7ed;
}

/* ATOMIC */
.pivot-table th[data-meta="ATOMIC"],
.pivot-table td[data-meta="ATOMIC"] {
    background-color: #fffaf0;
}
/* left border at start of each HEAD block */
.pivot-table th[data-meta="HEAD"],
.pivot-table td[data-meta="HEAD"] {
    border-left: 3px solid #5b8cff;
}
.pivot-table th[data-head="[EMPLOYEE]"],
.pivot-table td[data-head="[EMPLOYEE]"] {
    background-color: #f8fbff;
}

.pivot-table th[data-head="[VEHICLES]"],
.pivot-table td[data-head="[VEHICLES]"] {
    background-color: #f9fff6;
}

.pivot-table th[data-head="[OTHERS]"],
.pivot-table td[data-head="[OTHERS]"] {
    background-color: #fff7f7;
}


</style>
<script>/*
document.addEventListener("DOMContentLoaded", function () {

    document.querySelectorAll(".pivot-table th.rotate").forEach(th => {
        const div = th.querySelector("div");

        // Temporarily remove rotation to measure natural height
        div.style.transform = "none";
        const height = div.scrollHeight;

        // Restore rotation
        div.style.transform = "translateX(-50%) rotate(-90deg)";

        if (height > 200) {
            th.classList.add("wrap");
        }
    });

});*/



</script>
