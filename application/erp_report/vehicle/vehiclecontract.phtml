<div style="margin-top:1%;">
	<div class="col-md-12 card filter-card" style="margin-bottom: 0px;">
	<div class="card-block" style="padding-top: 1%;">
	<div class="full-width">
		<button name="cmdPrint" value="  Print  " onclick="$('#report').printElement();" class="btn btn btn-primary pull-right" style="padding: 2px 12px;">Print</button></div>
		<h5 class="title-margin">Report: Vehicle</h5>
	</div>	
		<form method="get" id="filter" name="filter" action="">
		<table class="">
			<tr style="font-size: 0.8em;">
				<th width="8%">No</th>
				<th>Type</th>
				<th  width="15%">Employee</th>
				<th  width="20%">Customer</th>
				<th width="15%">Status</th>
			</tr>
			<tr>
				<td width="8%">
					<div class="form-group ">
                	<?=$this->form->f_vehicle->show()?>
              		</div>
				</td>
				<td width="5%">
					<div class="form-group ">
                	<?=$this->form->f_type->show()?>
              		</div>
				</td>
				<td  width="15%">
					<div class="form-group ">
                	<?=$this->form->f_employee->show()?>
              		</div>
				</td>
				<td  width="20%">
					<div class="form-group ">
                	<?=$this->form->f_customer->show()?>
              		</div>
				</td>
				<td>
					<div class="form-group ">
                	<?=$this->form->f_status->show()?>
              		</div>
				</td>
				<td width="15%" align="center">
	              <div class="form-group ">
					<button class="btn <?=$this->filter_class?>" type="submit" >Filter</button>
					<input class="btn btn-secondary" name="clear" type="submit" value="All"></input>
	              </div>
				</td>
			</tr>
		</table>
	</div>

<div class="col-md-12 " style="height: 100%; padding-left: 1%; padding-right: 1%;">
<div id="report">
<?php include __DIR__ . '/../../../public/css/printstyle_rpt.php.css';?>
	<div  class="card" style="margin-top: 10px; padding-left: 5px; border-right-width: 1px; margin-right: 0px; padding-right: 5px;">
					<div style="margin-top: 3%;">
						<table class="rpt_tbl">
				<thead>
					<tr>
						<th width="1%" rowspan="3">
							<div class="title-margin">
								<img width="50" alt=""
									src="http://<?=$_SERVER ['HTTP_HOST']?>/css/images/ast.png"
									style="padding-top: 6px; padding-left: 0px; margin-left: 42px; margin-top: 5px;">
							</div>
						</th>
					</tr>
					<tr>
						<th ><div class="center" style="width: 79%;">Abdullah
								Salem Trading Est</div></th>
					</tr>
					<tr>
						<th width=""><div class="center"
								style="margin-top: 0px; margin-bottom: 10px; width: 79%;">Vehicle Employee Contract Report</div></th>
					</tr>
				</thead>
			</table>
		</div>
	
	<?php if (count($this->contractList) > 0): ?>
	<?php 
		$currentType = null;
		$currentVehicle = null;
		$offset = 0;

		// --- Step 1: Initialize tracking arrays ---
		$usedEmpIds = [];
		$usedVehIds = [];
	?>
	
	<?php foreach ($this->contractList as $vehicle): ?>
		<?php 
			// Collect used employee & vehicle IDs
			if (!empty($vehicle['emc_emp_id'])) $usedEmpIds[] = $vehicle['emc_emp_id'];
			if (!empty($vehicle['emc_vhl_id'])) $usedVehIds[] = $vehicle['emc_vhl_id'];

			// --- Start new type section ---
			if ($currentType !== $vehicle['type_name']):
				if ($currentType !== null): ?>
						</tbody>
					</table>
				<?php endif; ?>

				<h4 class="type-title" style="margin-top:25px; background:#dfe8f7; padding:10px; border-radius:5px;">
					<?=$vehicle['type_name']?>
				</h4>

				<table class="rpt_frame" style="width:100%; border-collapse:collapse; margin-bottom:20px;">
					<thead>
						<tr>
							<th width="3%" class="center">Sl.</th>
							<th width="10%" class="center">Customer</th>
							<th width="10%" class="center">Employee</th>
							<th width="4%" class="center">Start Date</th>
							<th width="4%" class="center">End Date</th>
							<th width="3%" class="center">Status</th>
							<th width="5%" class="center">Project</th>
							<th width="5%" class="center">Location</th>
							<th width="10%" class="center">Note</th>
						</tr>
					</thead>
					<tbody>
				<?php 
					$currentType = $vehicle['type_name']; 
					$currentVehicle = null;
				endif; 
		?>

		<?php if ($currentVehicle !== $vehicle['vhl_no']): ?>
			<tr class="vehicle-subheader">
				<td colspan="9" style="background:#f4f6fa; font-weight:bold; padding:5px 20px;">
					Vehicle No: <?=$vehicle['vhl_no']?>
				</td>
			</tr>
			<?php $currentVehicle = $vehicle['vhl_no']; ?>
		<?php endif; ?>

		<tr>
			<td class="center"><?= ++$offset; ?></td>
			<td><?=$vehicle['cust_name']?></td>
			<td><?=$vehicle['emp_name']?></td>
			<td class="center"><?=$vehicle['sts_start_date']?></td>
			<td class="center"><?=$vehicle['sts_end_date']?></td>
			<td class="center"><?=$vehicle['status']?></td>					
			<td><?=$vehicle['emc_project']?></td>
			<td><?=$vehicle['emc_location']?></td>
			<td><?=$vehicle['emc_note']?></td>
		</tr>
	<?php endforeach; ?>

	</tbody>
	</table>

	
<?php if($this->f_status==1):?>

	<!-- Step 4: Summary Section -->
	<hr style="margin-top:40px;">

<?php 
    // Step 1: Deduplicate used IDs
    $usedEmpIds = array_unique($usedEmpIds);
    $usedVehIds = array_unique($usedVehIds);

    // Step 2: Find unassigned ones
    $unassignedEmps = array_diff_key($this->activeEmpList, array_flip($usedEmpIds));
    $unassignedVehs = array_diff_key($this->vehList, array_flip($usedVehIds));

    // Step 3: Find assigned ones (those that are in use)
    $assignedEmps = array_intersect_key($this->activeEmpList, array_flip($usedEmpIds));
    $assignedVehs = array_intersect_key($this->vehList, array_flip($usedVehIds));
?>


<style>
.table-pair {
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	gap: 20px;
	margin-top: 25px;
}
.table-block {
	flex: 1;
	min-width: 45%;
}
.table-block h4 {
	color: #2a3f5f;
	margin-bottom: 10px;
}
.table-block table {
	width: 100%;
}
.center {
	text-align: center;
}
</style>


<!-- =============================== -->
<!-- UNDER CONTRACT ROW -->
<!-- =============================== -->
<div class="table-pair">
	<div class="table-block">
		<h4>Employees Under Contract</h4>
		<?php if (count($assignedEmps) > 0): ?>
			<table class="rpt_frame">
				<thead>
					<tr>
						<th width="10%" class="center">Sl.</th>
						<th>Employee Name</th>
					</tr>
				</thead>
				<tbody>
					<?php $emSl = 0; ?>
					<?php foreach ($assignedEmps as $empId => $empName): ?>
						<tr>
							<td class="center"><?= ++$emSl ?></td>
							<td>
								<a href="/erp_report/vehicle/vehiclecontract?f_employee=<?=$empId?>" style="text-decoration:none; color:#004085;">
									<?=$empName?>
								</a>
							</td>
						</tr>
					<?php endforeach; ?>
				</tbody>
			</table>
		<?php else: ?>
			<p><em>No employees currently have an active contract.</em></p>
		<?php endif; ?>
	</div>

	<div class="table-block">
		<h4>Vehicles Under Contract</h4>
		<?php if (count($assignedVehs) > 0): ?>
			<table class="rpt_frame">
				<thead>
					<tr>
						<th width="10%" class="center">Sl.</th>
						<th>Vehicle No</th>
					</tr>
				</thead>
				<tbody>
					<?php $vhSl = 0; ?>
					<?php foreach ($assignedVehs as $vehId => $vehNo): ?>
						<tr>
							<td class="center"><?= ++$vhSl ?></td>
							<td>
								<a href="/erp_report/vehicle/vehiclecontract?f_vehicle=<?=$vehId?>" style="text-decoration:none; color:#004085;">
									<?=$vehNo?>
								</a>
							</td>
						</tr>
					<?php endforeach; ?>
				</tbody>
			</table>
		<?php else: ?>
			<p><em>No vehicles are currently under contract.</em></p>
		<?php endif; ?>
	</div>
</div>



<!-- =============================== -->
<!-- WITHOUT CONTRACT ROW -->
<!-- =============================== -->
<div class="table-pair">
	<div class="table-block">
		<h4>Employees Without Contract</h4>
		<?php if (count($unassignedEmps) > 0): ?>
			<table class="rpt_frame">
				<thead>
					<tr>
						<th width="10%" class="center">Sl.</th>
						<th>Employee Name</th>
					</tr>
				</thead>
				<tbody>
					<?php $emSl = 0; ?>
					<?php foreach ($unassignedEmps as $empId => $empName): ?>
						<tr>
							<td class="center"><?= ++$emSl ?></td>
							<td>
								<a href="/erp_report/vehicle/vehiclecontract?f_employee=<?=$empId?>" style="text-decoration:none; color:#004085;">
									<?=$empName?>
								</a>
							</td>
						</tr>
					<?php endforeach; ?>
				</tbody>
			</table>
		<?php else: ?>
			<p><em>All employees are assigned to active contracts.</em></p>
		<?php endif; ?>
	</div>

	<div class="table-block">
		<h4>Vehicles Without Contract</h4>
		<?php if (count($unassignedVehs) > 0): ?>
			<table class="rpt_frame">
				<thead>
					<tr>
						<th width="10%" class="center">Sl.</th>
						<th>Vehicle No</th>
					</tr>
				</thead>
				<tbody>
					<?php $vhSl = 0; ?>
					<?php foreach ($unassignedVehs as $vehId => $vehNo): ?>
						<tr>
							<td class="center"><?= ++$vhSl ?></td>
							<td>
								<a href="/erp_report/vehicle/vehiclecontract?f_vehicle=<?=$vehId?>" style="text-decoration:none; color:#004085;">
									<?=$vehNo?>
								</a>
							</td>
						</tr>
					<?php endforeach; ?>
				</tbody>
			</table>
		<?php else: ?>
			<p><em>All vehicles are currently under contract.</em></p>
		<?php endif; ?>
	</div>
</div>


	
	
	<?php endif;?>
	

<?php else: ?>
	<p style="text-align:center;">No contracts found.</p>
<?php endif; ?>
	
	

		<div>
			<table class="rpt_tbl">
				<thead>
					<tr><?php $date = new DateTime();
					$date = $date->format('d/m/y')?>
						<th><div class="title-margin rpt_footer"><h5>Vehicle MIS Report - Vehicle Employee Contract (<?=$date?>)</h5></div></th>
					</tr>
				</thead>
			</table>
		</div>
	</div>
</div>
</div>
</div>
</form>
<script type="text/javascript">           
$(document).ready(function() {
    $('#f_monthpick').MonthPicker({ Button: false });
});
</script>

<style>
.type-title {
	background: #dfe8f7;
	color: #2a3f5f;
	font-weight: bold;
	padding: 8px 12px;
	margin-top: 20px;
	border-left: 4px solid #9cb4d8;
	border-radius: 4px;
}

.vehicle-subheader {
	background: #f8f9fc;
	font-weight: bold;
}

.rpt_frame th, .rpt_frame td {
	border: 1px solid #ccc;
	padding: 6px 8px;
	font-size: 14px;
}

.rpt_frame th {
	background: #eef2f7;
}

</style>

